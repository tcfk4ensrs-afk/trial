<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>メインモニター - 高度解析システム</title>
    <style>
        body { background: #000; color: #0f0; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: 'Courier New', monospace; overflow: hidden; transition: color 0.2s; }
        #output { font-size: 3.5vw; text-shadow: 0 0 10px #0f0; width: 85%; line-height: 1.8; text-align: center; white-space: pre-wrap; position: relative; z-index: 5; }
        .corrupting { animation: glitch-corrupt 0.1s infinite; filter: blur(1px); }
        @keyframes glitch-corrupt { 0% { transform: translate(2px, -2px); } 50% { transform: translate(-2px, 2px) skew(10deg); opacity: 0.8; } 100% { transform: translate(0,0); } }
        #noise-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('https://upload.wikimedia.org/wikipedia/commons/5/5a/Canal_9_Static.gif'); opacity: 0; pointer-events: none; z-index: 100; }
        .show-noise { opacity: 0.5 !important; }
        .full-noise { opacity: 1.0 !important; }
        body.special-mode { background: #000; color: #f00; }
        body.special-mode #output { text-shadow: 0 0 15px #f00; }
        #shutdown-line { position: fixed; top: 50%; left: 0; width: 100%; height: 2px; background: #fff; transform: scaleX(0); z-index: 101; display: none; transition: transform 0.2s; }
        #output::after { content: "|"; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body>
    <div id="noise-screen"></div>
    <div id="shutdown-line"></div>
    <div id="output">SYSTEM READY...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDC63eGF-F7ftg-gXv-YjsShTVzRPD91Qw",
            authDomain: "mystery-trial.firebaseapp.com",
            databaseURL: "https://mystery-trial-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mystery-trial",
            storageBucket: "mystery-trial.firebasestorage.app",
            messagingSenderId: "320751112246",
            appId: "1:320751112246:web:eb17abbde17c8bad08c897"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const outputElement = document.getElementById('output');
        const noiseScreen = document.getElementById('noise-screen');
        const shutdownLine = document.getElementById('shutdown-line');
        let typeTimer = null;
        let currentMode = "normal";
        let isFirstSpecial = true;
        let isSortedMode = false; // 「そのまま」モードフラグ

        // 基本のシャッフル関数
        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // セーフシャッフル：偶然「お」「わ」「り」の順にならないようにする
        function safeShuffle(array) {
            if (array.length !== 3) return shuffle(array);
            let result;
            let isOwari;
            do {
                result = shuffle(array);
                isOwari = (result[0] === "お" && result[1] === "わ" && result[2] === "り");
            } while (isOwari);
            return result;
        }

        function typeWriter(text, speed = 70) {
            if (typeTimer) clearInterval(typeTimer);
            outputElement.innerText = "";
            let i = 0;
            typeTimer = setInterval(() => {
                if (i < text.length) {
                    outputElement.innerText += text.charAt(i);
                    i++;
                } else {
                    clearInterval(typeTimer);
                }
            }, speed); 
        }

        function getGarbageText(length) {
            const chars = "ｦｧｨｩｪｫｬｭｮｯｰｱｲｳｴｵｶｷｸｹｺｻｼｽｾｿﾀﾁﾂﾃﾄﾅﾆﾇﾈﾉﾊﾋﾌﾍﾎﾏﾐﾑﾒﾓﾔﾕﾖﾗﾘﾙﾚﾛﾜﾝ@#$%&*?<>∑Ω≈";
            return Array.from({length}, () => chars[Math.floor(Math.random()*chars.length)]).join("");
        }

        // 緊急モード時のリスト表示（「そのまま」を除外して表示）
        function showSpecialList(list) {
            const filtered = list.filter(item => item !== "そのまま");
            const specialContent = "「そのまま」と送ってください\n\n" + filtered.join("  ");
            typeWriter(specialContent, 30);
        }

        async function triggerSpecialSequence(list) {
            outputElement.classList.add('corrupting');
            let count = 0;
            const corruptInterval = setInterval(() => {
                outputElement.innerText = getGarbageText(50);
                if (count++ > 20) {
                    clearInterval(corruptInterval);
                    noiseScreen.classList.add('show-noise');
                    setTimeout(shutdown, 500);
                }
            }, 100);

            function shutdown() {
                noiseScreen.classList.remove('show-noise');
                outputElement.innerText = "";
                shutdownLine.style.display = "block";
                setTimeout(() => { shutdownLine.style.transform = "scaleX(1)"; }, 10);
                setTimeout(() => {
                    shutdownLine.style.transform = "scaleX(0)";
                    setTimeout(reboot, 1500);
                }, 200);
            }

            function reboot() {
                noiseScreen.classList.add('full-noise');
                setTimeout(() => {
                    noiseScreen.classList.remove('full-noise');
                    document.body.classList.add('special-mode');
                    showSpecialList(list);
                }, 800);
            }
        }

        onValue(ref(db, 'mystery/mode'), (modeSnap) => {
            const nextMode = modeSnap.val();
            const messagesRef = ref(db, 'mystery/messages');

            onValue(messagesRef, (msgSnap) => {
                const list = msgSnap.val() || [];
                
                // 「そのまま」が含まれているかチェック
                if (list.includes("そのまま")) {
                    isSortedMode = true;
                }

                // リセット時にフラグを初期化
                if (nextMode === "normal" && list.length === 0) {
                    isSortedMode = false;
                }

                // 緊急モードへの移行
                if (nextMode === "special") {
                    if (currentMode === "normal") {
                        currentMode = "special";
                        if (isFirstSpecial) {
                            isFirstSpecial = false;
                            triggerSpecialSequence(list);
                        } else {
                            document.body.classList.add('special-mode');
                            showSpecialList(list);
                        }
                    } else {
                        document.body.classList.add('special-mode');
                        showSpecialList(list);
                    }
                    return;
                }

                // 通常モード
                if (nextMode === "normal") {
                    currentMode = "normal";
                    isFirstSpecial = true;
                    document.body.classList.remove('special-mode');
                    outputElement.classList.remove('corrupting');
                    shutdownLine.style.display = "none";

                    // 「そのまま」を除外したリストを作成
                    const filtered = list.filter(item => item !== "そのまま");
                    
                    if (filtered.length === 0) {
                        typeWriter("システム待機中...\nキーワードを入力してください。");
                    } else if (filtered.length === 1) {
                        typeWriter("キーワードを1つ受信しました。\n残り2つです。");
                    } else if (filtered.length === 2) {
                        typeWriter("キーワードを2つ受信しました。\n残り1つです。");
                    } else {
                        // 3つ揃った場合
                        // isSortedModeならそのまま、そうでなければsafeShuffle
                        const displayList = isSortedMode ? filtered : safeShuffle(filtered);
                        const finalContent = "解析が完了しました。回答を表示します：\n\n" + displayList.join("  ");
                        typeWriter(finalContent);
                    }
                }
            });
        });
    </script>
</body>
</html>
