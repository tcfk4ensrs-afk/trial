<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>操作パネル（本人）</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #eef2f3; transition: background 0.5s; }
        .box { max-width: 450px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        input { padding: 12px; width: 85%; margin: 15px 0; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
        button { padding: 12px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; width: 90%; font-size: 16px; margin-bottom: 10px; }
        .danger-btn { background: #dc3545; margin-top: 30px; font-size: 14px; opacity: 0.8; }
        hr { margin: 25px 0; border: 0; border-top: 1px solid #eee; }

        .zodiac-table { width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 14px; }
        .zodiac-table td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
        .z-input { width: 40px !important; padding: 5px !important; margin: 0 !important; text-align: center; }

        #secret-msg { 
            display: none; 
            margin: 20px 0; 
            padding: 15px; 
            background: #fff3cd; 
            color: #856404; 
            font-weight: bold; 
            border: 2px solid #ffeeba; 
            border-radius: 8px; 
            animation: pop 0.3s ease-out;
        }
        @keyframes pop { from { transform: scale(0.8); } to { transform: scale(1); } }
        .flash-effect { background: #007bff !important; }
    </style>
</head>
<body id="body-bg">
    <div id="main-content" class="box">読み込み中...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDC63eGF-F7ftg-gXv-YjsShTVzRPD91Qw",
            authDomain: "mystery-trial.firebaseapp.com",
            databaseURL: "https://mystery-trial-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mystery-trial",
            storageBucket: "mystery-trial.firebasestorage.app",
            messagingSenderId: "320751112246",
            appId: "1:320751112246:web:eb17abbde17c8bad08c897"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const params = new URLSearchParams(window.location.search);
        const tagId = params.get('id');

        const messageMaster = {
            "そのまま": "そのまま",
            "おひつじ": "お", "おうし": "が", "ふたご": "わ", "かに": "ほ",
            "しし": "し", "おとめ": "の", "てんびん": "あ", "さそり": "り",
            "いて": "ず", "やぎ": "み", "みずがめ": "い", "うお": "よ"
        };

        let inputHistory = [];

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        async function init() {
            const tagSnapshot = await get(ref(db, `tags/${tagId}`));
            const data = tagSnapshot.val();
            if (!data) return;

            const zodiacKeys = Object.keys(messageMaster).filter(key => key !== "そのまま");
            const shuffledKeys = shuffleArray([...zodiacKeys]);

            let zodiacHTML = `<table class="zodiac-table"><tr><th>星座</th><th>文字</th></tr>`;
            shuffledKeys.forEach(key => {
                zodiacHTML += `
                    <tr>
                        <td>${key}座</td>
                        <td><input type="text" class="z-input" data-ans="${messageMaster[key]}" maxlength="1"></td>
                    </tr>`;
            });
            zodiacHTML += `</table>`;

            document.getElementById('main-content').innerHTML = `
                <h3>管理者：${data.playerName} さん</h3>
                <input type="text" id="ansInput" placeholder="答えを入力">
                <button id="sendBtn">送信</button>
                <div id="secret-msg">✨ 指示：モニターに「いのり」と表示させよう ✨</div>
                <hr>
                ${zodiacHTML}
                <button class="danger-btn" id="resetBtn">モニターリセット</button>
            `;

            document.querySelectorAll('.z-input').forEach(input => {
                input.addEventListener('input', checkZodiacPuzzle);
            });

            // ★【追加機能】モニターの文字を常時監視して自動クリア
            onValue(ref(db, 'mystery/messages'), (snap) => {
                const rawList = snap.val() || [];
                const filteredList = rawList.filter(item => item !== "そのまま");
                
                // 「お」「わ」「り」の順で3文字揃っているか判定
                const isCorrect = filteredList.length === 3 && 
                                  filteredList[0] === "お" && 
                                  filteredList[1] === "わ" && 
                                  filteredList[2] === "り";

                if (isCorrect) {
                    // 条件が揃ったら即座に遷移
                    window.location.href = `clear.html?id=${tagId}`;
                }
            });

            document.getElementById('sendBtn').onclick = async () => {
                const val = document.getElementById('ansInput').value.trim();
                const msgRef = ref(db, 'mystery/messages');
                const modeRef = ref(db, 'mystery/mode');
                
                // 「おわり」の手動入力は不要になりましたが、互換性のために残しています
                if (val === "おわり") {
                    const snap = await get(msgRef);
                    const rawList = snap.val() || [];
                    const filteredList = rawList.filter(item => item !== "そのまま");
                    const isCorrect = filteredList.length === 3 && filteredList[0] === "お" && filteredList[1] === "わ" && filteredList[2] === "り";

                    if (isCorrect) {
                        window.location.href = `clear.html?id=${tagId}`;
                    } else {
                        alert("まだ終われません。モニターの表示を「お」「わ」「り」の順に揃えてください。");
                    }
                    return;
                }

                const result = messageMaster[val];
                if (result) {
                    inputHistory.push(val);
                    if (inputHistory.length > 3) inputHistory.shift();
                    if (inputHistory.length === 3 && ["みずがめ", "おとめ", "さそり"].every((v, i) => v === inputHistory[i])) {
                        await set(modeRef, "special");
                        alert("「そのまま」と打とう");
                    }

                    const snap = await get(msgRef);
                    let list = snap.val() || [];
                    const isSortedMode = list.includes("そのまま");
                    let currentChars = list.filter(item => item !== "そのまま");
                    
                    if (val === "そのまま") {
                        if (!isSortedMode) list.push("そのまま");
                    } else {
                        currentChars.push(result);
                        if (currentChars.length > 3) currentChars.shift();
                        list = isSortedMode ? ["そのまま", ...currentChars] : currentChars;
                    }
                    
                    await set(msgRef, list);
                    alert(val === "そのまま" ? "リスト表示モード（青）を起動しました" : `「${val}」送信完了`);
                    document.getElementById('ansInput').value = "";
                } else {
                    alert("キーワードが違います。");
                }
            };

            document.getElementById('resetBtn').onclick = async () => {
                if(confirm("全消去して初期状態に戻しますか？")){
                    await set(ref(db, 'mystery/messages'), null);
                    await set(ref(db, 'mystery/mode'), "normal");
                    inputHistory = [];
                    alert("リセット完了");
                }
            };
        }

        function checkZodiacPuzzle() {
            const inputs = document.querySelectorAll('.z-input');
            let correctCount = 0;
            inputs.forEach(input => { if (input.value === input.dataset.ans) correctCount++; });
            if (correctCount === 12) {
                const bg = document.getElementById('body-bg');
                bg.classList.add('flash-effect');
                setTimeout(() => bg.classList.remove('flash-effect'), 500);
                document.getElementById('secret-msg').style.display = "block";
            }
        }
        init();
    </script>
</body>
</html>
